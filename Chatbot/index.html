<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Legal Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .messages-container {
      scrollbar-width: thin;
      scrollbar-color: #CBD5E0 transparent;
    }
    .messages-container::-webkit-scrollbar {
      width: 6px;
    }
    .messages-container::-webkit-scrollbar-track {
      background: transparent;
    }
    .messages-container::-webkit-scrollbar-thumb {
      background-color: #CBD5E0;
      border-radius: 3px;
    }
    .message-content ul {
      list-style-type: none;
      padding-left: 1rem;
    }
    .message-content ul li {
      position: relative;
      margin: 0.5rem 0;
    }
    .message-content ul li::before {
      content: "â€¢";
      position: absolute;
      left: -1rem;
      color: currentColor;
    }
    .message-content strong {
      font-weight: 600;
    }
    .tab-active {
      background-color: #EBF5FF;
      border-left: 4px solid #3B82F6;
    }
  </style>
</head>
<body>
  <div class="flex h-screen bg-gray-100">
    <!-- Sidebar -->
    <div class="w-64 bg-white border-r border-gray-200 flex flex-col">
      <!-- Tabs -->
      <div class="border-b border-gray-200">
        <div class="p-4 space-y-2">
          <button id="newChatBtn" class="w-full flex items-center justify-center gap-2 bg-blue-600 text-white rounded-lg py-2 px-4 hover:bg-blue-700 transition-colors">
            <i data-lucide="message-circle" class="w-5 h-5"></i>
            <span>New chat</span>
          </button>
          <div class="space-y-1">
            <button data-section="main" class="tab-button tab-active w-full text-left px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
              <i data-lucide="message-square" class="w-5 h-5"></i>
              <span>Chat</span>
            </button>
            <button data-section="for_against" class="tab-button w-full text-left px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-gray-100 transition-colors">
              <i data-lucide="scale" class="w-5 h-5"></i>
              <span>For/Against</span>
            </button>
            <button data-section="bare_acts" class="tab-button w-full text-left px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-gray-100 transition-colors">
              <i data-lucide="book-open" class="w-5 h-5"></i>
              <span>Explanations to Sections</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Search Section -->
      <div class="px-4 py-2">
        <div class="relative">
          <input
            type="text"
            id="searchInput"
            placeholder="Search messages"
            class="w-full pl-9 pr-4 py-2 bg-gray-100 border border-transparent rounded-lg text-sm focus:outline-none focus:border-gray-300 transition-colors"
          />
          <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
        </div>
      </div>
      
      <!-- Chat History -->
      <div id="chatHistory" class="px-4 mt-4 flex-1 overflow-y-auto">
        <!-- Chat history will be populated here -->
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
      <!-- Chat Header -->
      <div class="h-14 border-b border-gray-200 flex items-center justify-between px-4 bg-white">
        <h1 id="sectionTitle" class="text-lg font-semibold text-gray-800">Chat</h1>
        <div id="statusIndicator" class="hidden">
          <div class="animate-pulse flex items-center">
            <div class="h-2 w-2 bg-green-500 rounded-full mr-2"></div>
            <span class="text-sm text-gray-500">Processing...</span>
          </div>
        </div>
      </div>

      <!-- Messages Container Wrapper -->
      <div class="flex-1 relative">
        <!-- Separate message containers for each section -->
        <div id="main-messages" class="messages-container absolute inset-0 overflow-y-auto p-4 space-y-4"></div>
        <div id="for_against-messages" class="messages-container absolute inset-0 overflow-y-auto p-4 space-y-4 hidden"></div>
        <div id="bare_acts-messages" class="messages-container absolute inset-0 overflow-y-auto p-4 space-y-4 hidden"></div>
      </div>

      <!-- Input Area -->
      <div class="border-t border-gray-200 p-4 bg-white">
        <form id="messageForm" class="flex gap-2">
          <input
            type="text"
            id="messageInput"
            placeholder="Type your message..."
            class="flex-1 rounded-lg border border-gray-300 px-4 py-2 focus:outline-none focus:border-blue-500"
          />
          <button
            type="submit"
            class="bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700 transition-colors flex items-center gap-2"
          >
            <i data-lucide="send" class="w-5 h-5"></i>
            <span>Send</span>
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    // API endpoints
    const API_BASE_URL = 'https://chatbot-u30628.vm.elestio.app/';
    
    // State management
    let currentSection = 'main';
    const sections = ['main', 'for_against', 'bare_acts'];
    const sectionTitles = {
      'main': 'Chat',
      'for_against': 'For/Against',
      'bare_acts': 'Explanations to Sections'
    };

    // DOM elements
    const messagesContainers = sections.reduce((acc, section) => {
      acc[section] = document.getElementById(`${section}-messages`);
      return acc;
    }, {});
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const newChatBtn = document.getElementById('newChatBtn');
    const chatHistory = document.getElementById('chatHistory');
    const searchInput = document.getElementById('searchInput');
    const statusIndicator = document.getElementById('statusIndicator');
    const sectionTitle = document.getElementById('sectionTitle');
    const tabButtons = document.querySelectorAll('.tab-button');

    // Add chat session tracking
    let currentChatId = null;
    const activeSessions = {
      'main': null,
      'for_against': null,
      'bare_acts': null
    };

    // Add initial bot message to all sections
    sections.forEach(section => {
      addMessage("How can I help you today?", true, section);
    });

    // Load chat history for all sections
    sections.forEach(loadChatHistory);

    // Event listeners
    messageForm.addEventListener('submit', handleSubmit);
    newChatBtn.addEventListener('click', () => handleNewChat(currentSection));
    searchInput.addEventListener('input', handleSearch);
    
    // Tab switching
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const section = button.dataset.section;
        switchSection(section);
      });
    });

    function switchSection(section) {
      // Update UI
      tabButtons.forEach(btn => {
        btn.classList.toggle('tab-active', btn.dataset.section === section);
      });
      
      // Hide all message containers and show the selected one
      Object.values(messagesContainers).forEach(container => container.classList.add('hidden'));
      messagesContainers[section].classList.remove('hidden');
      
      // Update current section and title
      currentSection = section;
      sectionTitle.textContent = sectionTitles[section];
      currentChatId = activeSessions[section];
      
      // Only load history if new chat was clicked or app was restarted
      if (!activeSessions[section]) {
        loadChatHistory(section);
      }
    }

    async function handleSubmit(e) {
      e.preventDefault();
      const message = messageInput.value.trim();
      if (!message) return;

      addMessage(message, false, currentSection);
      messageInput.value = '';
      
      statusIndicator.classList.remove('hidden');

      try {
        const response = await fetch(`${API_BASE_URL}chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            query: message,
            section: currentSection,
            chat_id: currentChatId
          }),
        });

        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        addMessage(data.answer, true, currentSection);
        
        // Update chat ID if this is a new chat
        if (!currentChatId) {
          currentChatId = data.chat_id;
          activeSessions[currentSection] = currentChatId;
        }
      } catch (error) {
        console.error('Error:', error);
        addMessage("Sorry, I encountered an error processing your request.", true, currentSection);
      } finally {
        statusIndicator.classList.add('hidden');
      }
    }

    async function handleNewChat(section) {
      try {
        await fetch(`${API_BASE_URL}history/${section}/clear`, { method: 'POST' });
        messagesContainers[section].innerHTML = '';
        currentChatId = null;
        activeSessions[section] = null;
        loadChatHistory(section);
        addMessage("How can I help you today?", true, section);
      } catch (error) {
        console.error('Error clearing chat history:', error);
      }
    }

    function handleSearch(e) {
      const searchTerm = e.target.value.toLowerCase();
      const historyItems = chatHistory.getElementsByClassName('history-item');
      
      Array.from(historyItems).forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? 'block' : 'none';
      });
    }

    async function loadChatHistory(section) {
      try {
        const response = await fetch(`${API_BASE_URL}history/${section}`);
        if (!response.ok) throw new Error('Network response was not ok');
        
        const history = await response.json();
        updateChatHistory(history, section);
      } catch (error) {
        console.error('Error loading chat history:', error);
      }
    }

    function updateChatHistory(groupedHistory, section) {
      const historySection = document.createElement('div');
      historySection.className = 'space-y-4';

      // Create sections for different time periods
      const periods = [
        { key: 'today', label: 'Today' },
        { key: 'yesterday', label: 'Yesterday' },
        { key: 'seven_days', label: '7 Days' },
        { key: 'thirty_days', label: '30 Days' }
      ];

      periods.forEach(period => {
        const chats = groupedHistory[period.key];
        if (chats && chats.length > 0) {
          const periodSection = document.createElement('div');
          periodSection.innerHTML = `
            <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">${period.label}</h3>
            <div class="space-y-1">
              ${chats.map(chat => `
                <div class="history-item text-sm text-gray-700 hover:bg-gray-100 rounded-lg px-3 py-2 cursor-pointer transition-colors">
                  ${chat.title}
                </div>
              `).join('')}
            </div>
          `;
          historySection.appendChild(periodSection);
        }
      });

      // Update history for current section only
      chatHistory.innerHTML = '';
      if (historySection.children.length > 0) {
        chatHistory.appendChild(historySection);
      }
    }

    function addMessage(text, isBot, section) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex ${isBot ? 'justify-start' : 'justify-end'}`;
      
      const messageContent = document.createElement('div');
      messageContent.className = `max-w-[80%] rounded-lg px-4 py-2 ${
        isBot ? 'bg-white text-gray-800' : 'bg-blue-600 text-white'
      } message-content`;

      if (isBot) {
        messageContent.innerHTML = marked.parse(text);
      } else {
        messageContent.textContent = text;
      }
      
      messageDiv.appendChild(messageContent);
      messagesContainers[section].appendChild(messageDiv);
      messagesContainers[section].scrollTop = messagesContainers[section].scrollHeight;
    }
  </script>
</body>
</html>